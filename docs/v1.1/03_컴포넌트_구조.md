# TaskFlow v1.1 컴포넌트 구조

> 작성일: 2024-12-21
> 버전: 1.1
> 이전 버전: v1.0 (docs/component/)

---

## 목차

1. [개요](#1-개요)
2. [백엔드 신규 컴포넌트](#2-백엔드-신규-컴포넌트)
3. [백엔드 수정 컴포넌트](#3-백엔드-수정-컴포넌트)
4. [프론트엔드 신규 컴포넌트](#4-프론트엔드-신규-컴포넌트)
5. [프론트엔드 수정 컴포넌트](#5-프론트엔드-수정-컴포넌트)
6. [패키지 구조 변경](#6-패키지-구조-변경)
7. [변경 요약](#7-변경-요약)

---

## 1. 개요

### 1.1 변경 목적
- 업무 공유 기능 추가 (Item Share)
- 통합 감사 로그 시스템 (Audit Log)
- 업무 이관 서비스 (Transfer Service)
- 보드 관리 기능 강화

### 1.2 컴포넌트 변경 요약

| 구분 | 백엔드 | 프론트엔드 |
|------|--------|-----------|
| 신규 Controller | 2 | - |
| 신규 Service | 3 | - |
| 신규 Mapper | 2 | - |
| 신규 Domain/DTO | 6 | 5 |
| 신규 View | - | 1 |
| 신규 Store Action | - | 6 |
| 신규 API Function | - | 9 |
| 수정 Controller | 1 | - |
| 수정 Service | 1 | - |
| 수정 Mapper | 1 | - |
| 수정 Store | - | 1 |
| 수정 Type | - | 2 |

---

## 2. 백엔드 신규 컴포넌트

### 2.1 ItemShare 컴포넌트

#### 2.1.1 ItemShareController

**파일 위치**: `src/main/java/com/taskflow/controller/ItemShareController.java`

| 메서드 | HTTP | URL | 설명 |
|--------|------|-----|------|
| getItemShares() | GET | /api/items/{itemId}/shares | 업무 공유 목록 |
| addItemShare() | POST | /api/items/{itemId}/shares | 업무 공유 추가 |
| updateItemSharePermission() | PUT | /api/items/{itemId}/shares/{userId} | 공유 권한 변경 |
| removeItemShare() | DELETE | /api/items/{itemId}/shares/{userId} | 업무 공유 제거 |

```java
@RestController
@RequestMapping("/api/items/{itemId}/shares")
@RequiredArgsConstructor
public class ItemShareController {
    private final ItemShareService itemShareService;

    @GetMapping
    public ApiResponse<List<ItemShareResponse>> getItemShares(@PathVariable Long itemId);

    @PostMapping
    public ApiResponse<ItemShareResponse> addItemShare(
        @PathVariable Long itemId,
        @RequestBody @Valid ItemShareRequest request
    );

    @PutMapping("/{userId}")
    public ApiResponse<ItemShareResponse> updateItemSharePermission(
        @PathVariable Long itemId,
        @PathVariable Long userId,
        @RequestBody @Valid ItemShareUpdateRequest request
    );

    @DeleteMapping("/{userId}")
    public ApiResponse<Void> removeItemShare(
        @PathVariable Long itemId,
        @PathVariable Long userId
    );
}
```

---

#### 2.1.2 ItemShareService

**파일 위치**: `src/main/java/com/taskflow/service/ItemShareService.java`

| 메서드 | 파라미터 | 반환 | 설명 |
|--------|---------|------|------|
| getItemShares() | Long itemId | List<ItemShareResponse> | 공유 목록 조회 |
| addItemShare() | Long itemId, ItemShareRequest | ItemShareResponse | 공유 추가 |
| updateItemSharePermission() | Long itemId, Long userId, ItemShareUpdateRequest | ItemShareResponse | 권한 변경 |
| removeItemShare() | Long itemId, Long userId | void | 공유 제거 |
| getItemsSharedToUser() | Long userId | List<ItemResponse> | 사용자가 공유받은 업무 목록 |
| hasSharePermission() | Long itemId, Long userId | String | 공유 권한 조회 |
| canShare() | Long itemId, Long userId | boolean | 공유 가능 여부 확인 |

```java
@Service
@RequiredArgsConstructor
public class ItemShareService {
    private final ItemShareMapper itemShareMapper;
    private final ItemMapper itemMapper;
    private final UserMapper userMapper;
    private final AuditLogService auditLogService;

    @Transactional
    public ItemShareResponse addItemShare(Long itemId, ItemShareRequest request) {
        // 1. 권한 검증
        // 2. 중복 검사
        // 3. 공유 추가
        // 4. 감사 로그 기록
        return response;
    }
}
```

---

#### 2.1.3 ItemShareMapper

**인터페이스 위치**: `src/main/java/com/taskflow/mapper/ItemShareMapper.java`

| 메서드 | 설명 |
|--------|------|
| selectItemSharesByItemId(Long itemId) | 업무별 공유 목록 |
| selectItemSharesByUserId(Long userId) | 사용자별 공유 업무 목록 |
| selectItemShare(Long itemId, Long userId) | 특정 공유 조회 |
| insertItemShare(ItemShare itemShare) | 공유 추가 |
| updatePermission(Long itemId, Long userId, String permission) | 권한 변경 |
| deleteItemShare(Long itemId, Long userId) | 공유 제거 |
| deleteByItemId(Long itemId) | 업무의 모든 공유 삭제 |
| hasPermission(Long itemId, Long userId) | 권한 존재 확인 |
| getPermission(Long itemId, Long userId) | 권한 조회 |

**XML 위치**: `src/main/resources/mapper/ItemShareMapper.xml`

```xml
<mapper namespace="com.taskflow.mapper.ItemShareMapper">
    <resultMap id="ItemShareResultMap" type="ItemShare">
        <id property="itemShareId" column="ITEM_SHARE_ID"/>
        <result property="itemId" column="ITEM_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="permission" column="PERMISSION"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="updatedBy" column="UPDATED_BY"/>
    </resultMap>

    <resultMap id="ItemShareWithUserResultMap" type="ItemShare">
        <id property="itemShareId" column="ITEM_SHARE_ID"/>
        <result property="itemId" column="ITEM_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="permission" column="PERMISSION"/>
        <association property="user" javaType="User">
            <id property="userId" column="U_USER_ID"/>
            <result property="username" column="U_USERNAME"/>
            <result property="name" column="U_NAME"/>
        </association>
    </resultMap>

    <select id="selectItemSharesByItemId" resultMap="ItemShareWithUserResultMap">
        SELECT
            s.ITEM_SHARE_ID, s.ITEM_ID, s.USER_ID, s.PERMISSION,
            s.CREATED_AT, s.CREATED_BY,
            u.USER_ID AS U_USER_ID, u.USERNAME AS U_USERNAME, u.NAME AS U_NAME
        FROM TB_ITEM_SHARE s
        INNER JOIN TB_USER u ON s.USER_ID = u.USER_ID
        WHERE s.ITEM_ID = #{itemId}
        ORDER BY s.CREATED_AT
    </select>

    <insert id="insertItemShare" useGeneratedKeys="true" keyProperty="itemShareId">
        INSERT INTO TB_ITEM_SHARE (ITEM_ID, USER_ID, PERMISSION, CREATED_AT, CREATED_BY)
        VALUES (#{itemId}, #{userId}, #{permission}, NOW(), #{createdBy})
    </insert>

    <update id="updatePermission">
        UPDATE TB_ITEM_SHARE
        SET PERMISSION = #{permission}, UPDATED_AT = NOW(), UPDATED_BY = #{updatedBy}
        WHERE ITEM_ID = #{itemId} AND USER_ID = #{userId}
    </update>

    <delete id="deleteItemShare">
        DELETE FROM TB_ITEM_SHARE
        WHERE ITEM_ID = #{itemId} AND USER_ID = #{userId}
    </delete>
</mapper>
```

---

### 2.2 AuditLog 컴포넌트

#### 2.2.1 AuditLogController

**파일 위치**: `src/main/java/com/taskflow/controller/AuditLogController.java`

| 메서드 | HTTP | URL | 설명 |
|--------|------|-----|------|
| getAuditLogs() | GET | /api/audit-logs | 감사 로그 목록 |
| getRecentAuditLogs() | GET | /api/audit-logs/recent | 최근 감사 로그 |
| getBoardAuditLogs() | GET | /api/audit-logs/boards/{boardId} | 보드별 감사 로그 |
| getItemAuditLogs() | GET | /api/audit-logs/items/{itemId} | 업무별 감사 로그 |

```java
@RestController
@RequestMapping("/api/audit-logs")
@RequiredArgsConstructor
public class AuditLogController {
    private final AuditLogService auditLogService;

    @GetMapping
    public ApiResponse<PageResponse<AuditLogResponse>> getAuditLogs(
        @RequestParam(required = false) String targetType,
        @RequestParam(required = false) String action,
        @RequestParam(required = false) Long actorId,
        @RequestParam(required = false) @DateTimeFormat(iso = ISO.DATE) LocalDate startDate,
        @RequestParam(required = false) @DateTimeFormat(iso = ISO.DATE) LocalDate endDate,
        @RequestParam(defaultValue = "0") int page,
        @RequestParam(defaultValue = "20") int size
    );

    @GetMapping("/recent")
    public ApiResponse<List<AuditLogSimpleResponse>> getRecentAuditLogs(
        @RequestParam(defaultValue = "10") int limit
    );

    @GetMapping("/boards/{boardId}")
    public ApiResponse<PageResponse<AuditLogResponse>> getBoardAuditLogs(
        @PathVariable Long boardId,
        @RequestParam(defaultValue = "0") int page,
        @RequestParam(defaultValue = "20") int size
    );

    @GetMapping("/items/{itemId}")
    public ApiResponse<PageResponse<AuditLogResponse>> getItemAuditLogs(
        @PathVariable Long itemId,
        @RequestParam(defaultValue = "0") int page,
        @RequestParam(defaultValue = "20") int size
    );
}
```

---

#### 2.2.2 AuditLogService

**파일 위치**: `src/main/java/com/taskflow/service/AuditLogService.java`

| 메서드 | 파라미터 | 반환 | 설명 |
|--------|---------|------|------|
| getAuditLogs() | AuditLogSearchCondition, Pageable | PageResponse | 목록 조회 |
| getRecentAuditLogs() | int limit | List<AuditLogSimpleResponse> | 최근 로그 |
| getBoardAuditLogs() | Long boardId, Pageable | PageResponse | 보드별 로그 |
| getItemAuditLogs() | Long itemId, Pageable | PageResponse | 업무별 로그 |
| logBoardCreate() | Long boardId, Board board, Long actorId | void | 보드 생성 로그 |
| logBoardUpdate() | Long boardId, Board before, Board after, Long actorId | void | 보드 수정 로그 |
| logBoardDelete() | Long boardId, Board board, Long actorId | void | 보드 삭제 로그 |
| logItemTransfer() | Long itemId, Long fromBoardId, Long toBoardId, Long toUserId, Long actorId | void | 이관 로그 |
| logBoardShare() | Long boardId, Long userId, String permission, Long actorId | void | 보드 공유 로그 |
| logBoardUnshare() | Long boardId, Long userId, Long actorId | void | 보드 공유 해제 로그 |
| logItemShare() | Long itemId, Long userId, String permission, Long actorId | void | 업무 공유 로그 |
| logItemUnshare() | Long itemId, Long userId, Long actorId | void | 업무 공유 해제 로그 |
| logPermissionChange() | String targetType, Long targetId, Long userId, String oldPermission, String newPermission, Long actorId | void | 권한 변경 로그 |

```java
@Service
@RequiredArgsConstructor
public class AuditLogService {
    private final AuditLogMapper auditLogMapper;
    private final ObjectMapper objectMapper;

    @Transactional
    public void logBoardShare(Long boardId, Long userId, String permission, Long actorId) {
        AuditLog log = AuditLog.builder()
            .targetType("BOARD_SHARE")
            .targetId(boardId)
            .action("SHARE")
            .actorId(actorId)
            .description(String.format("보드 공유 추가 (권한: %s)", permission))
            .afterData(toJson(Map.of("userId", userId, "permission", permission)))
            .relatedUserId(userId)
            .build();
        auditLogMapper.insertAuditLog(log);
    }

    private String toJson(Object obj) {
        try {
            return objectMapper.writeValueAsString(obj);
        } catch (JsonProcessingException e) {
            return null;
        }
    }
}
```

---

#### 2.2.3 AuditLogMapper

**인터페이스 위치**: `src/main/java/com/taskflow/mapper/AuditLogMapper.java`

| 메서드 | 설명 |
|--------|------|
| selectAuditLogs(AuditLogSearchCondition, Pageable) | 로그 목록 조회 |
| selectAuditLogCount(AuditLogSearchCondition) | 로그 수 조회 |
| selectRecentAuditLogs(int limit) | 최근 로그 조회 |
| selectAuditLogsByTarget(String targetType, Long targetId, Pageable) | 대상별 로그 |
| selectAuditLogsByBoard(Long boardId, Pageable) | 보드 관련 로그 |
| selectAuditLogsByItem(Long itemId, Pageable) | 업무 관련 로그 |
| insertAuditLog(AuditLog auditLog) | 로그 저장 |

**XML 위치**: `src/main/resources/mapper/AuditLogMapper.xml`

```xml
<mapper namespace="com.taskflow.mapper.AuditLogMapper">
    <resultMap id="AuditLogResultMap" type="AuditLog">
        <id property="logId" column="LOG_ID"/>
        <result property="targetType" column="TARGET_TYPE"/>
        <result property="targetId" column="TARGET_ID"/>
        <result property="action" column="ACTION"/>
        <result property="actorId" column="ACTOR_ID"/>
        <result property="description" column="DESCRIPTION"/>
        <result property="beforeData" column="BEFORE_DATA"/>
        <result property="afterData" column="AFTER_DATA"/>
        <result property="relatedUserId" column="RELATED_USER_ID"/>
        <result property="ipAddress" column="IP_ADDRESS"/>
        <result property="userAgent" column="USER_AGENT"/>
        <result property="createdAt" column="CREATED_AT"/>
    </resultMap>

    <resultMap id="AuditLogWithNamesResultMap" type="AuditLog">
        <id property="logId" column="LOG_ID"/>
        <result property="targetType" column="TARGET_TYPE"/>
        <result property="targetId" column="TARGET_ID"/>
        <result property="action" column="ACTION"/>
        <result property="actorId" column="ACTOR_ID"/>
        <result property="actorName" column="ACTOR_NAME"/>
        <result property="description" column="DESCRIPTION"/>
        <result property="relatedUserId" column="RELATED_USER_ID"/>
        <result property="relatedUserName" column="RELATED_USER_NAME"/>
        <result property="createdAt" column="CREATED_AT"/>
    </resultMap>

    <sql id="searchCondition">
        <where>
            <if test="targetType != null">
                AND TARGET_TYPE = #{targetType}
            </if>
            <if test="action != null">
                AND ACTION = #{action}
            </if>
            <if test="actorId != null">
                AND ACTOR_ID = #{actorId}
            </if>
            <if test="startDate != null">
                AND CREATED_AT >= #{startDate}
            </if>
            <if test="endDate != null">
                AND CREATED_AT &lt; DATE_ADD(#{endDate}, INTERVAL 1 DAY)
            </if>
        </where>
    </sql>

    <select id="selectAuditLogs" resultMap="AuditLogWithNamesResultMap">
        SELECT
            l.LOG_ID, l.TARGET_TYPE, l.TARGET_ID, l.ACTION,
            l.ACTOR_ID, u1.NAME AS ACTOR_NAME,
            l.DESCRIPTION, l.BEFORE_DATA, l.AFTER_DATA,
            l.RELATED_USER_ID, u2.NAME AS RELATED_USER_NAME,
            l.CREATED_AT
        FROM TB_AUDIT_LOG l
        LEFT JOIN TB_USER u1 ON l.ACTOR_ID = u1.USER_ID
        LEFT JOIN TB_USER u2 ON l.RELATED_USER_ID = u2.USER_ID
        <include refid="searchCondition"/>
        ORDER BY l.CREATED_AT DESC
        LIMIT #{pageable.pageSize} OFFSET #{pageable.offset}
    </select>

    <insert id="insertAuditLog" useGeneratedKeys="true" keyProperty="logId">
        INSERT INTO TB_AUDIT_LOG (
            TARGET_TYPE, TARGET_ID, ACTION, ACTOR_ID,
            DESCRIPTION, BEFORE_DATA, AFTER_DATA,
            RELATED_USER_ID, IP_ADDRESS, USER_AGENT, CREATED_AT
        ) VALUES (
            #{targetType}, #{targetId}, #{action}, #{actorId},
            #{description}, #{beforeData}, #{afterData},
            #{relatedUserId}, #{ipAddress}, #{userAgent}, NOW()
        )
    </insert>
</mapper>
```

---

### 2.3 Transfer 컴포넌트

#### 2.3.1 TransferService

**파일 위치**: `src/main/java/com/taskflow/service/TransferService.java`

| 메서드 | 파라미터 | 반환 | 설명 |
|--------|---------|------|------|
| getTransferPreview() | Long boardId | TransferPreviewResponse | 이관 미리보기 |
| transferItems() | Long fromBoardId, Long toUserId, String reason, Long actorId | TransferResultResponse | 업무 이관 실행 |
| createTransferBoard() | Long userId, String originalBoardName | Board | 이관 보드 생성 |
| moveItemsToBoard() | List<Long> itemIds, Long toBoardId, Long fromBoardId | int | 업무 이동 |

```java
@Service
@RequiredArgsConstructor
public class TransferService {
    private final ItemMapper itemMapper;
    private final BoardMapper boardMapper;
    private final BoardService boardService;
    private final AuditLogService auditLogService;

    @Transactional
    public TransferResultResponse transferItems(
            Long fromBoardId,
            Long toUserId,
            String reason,
            Long actorId) {

        // 1. 이관 대상 업무 조회
        List<Item> pendingItems = itemMapper.selectPendingItemsByBoardId(fromBoardId);

        if (pendingItems.isEmpty()) {
            return TransferResultResponse.empty(fromBoardId);
        }

        // 2. 이관 보드 생성
        Board originalBoard = boardMapper.selectBoardById(fromBoardId);
        Board transferBoard = createTransferBoard(toUserId, originalBoard.getBoardName());

        // 3. 업무 이동
        List<Long> itemIds = pendingItems.stream()
            .map(Item::getItemId)
            .collect(Collectors.toList());

        int movedCount = moveItemsToBoard(itemIds, transferBoard.getBoardId(), fromBoardId);

        // 4. 감사 로그 기록
        for (Item item : pendingItems) {
            auditLogService.logItemTransfer(
                item.getItemId(),
                fromBoardId,
                transferBoard.getBoardId(),
                toUserId,
                actorId
            );
        }

        return TransferResultResponse.builder()
            .deletedBoardId(fromBoardId)
            .deletedBoardName(originalBoard.getBoardName())
            .transferredItems(movedCount)
            .transferredToUserId(toUserId)
            .newBoardId(transferBoard.getBoardId())
            .newBoardName(transferBoard.getBoardName())
            .build();
    }

    private Board createTransferBoard(Long userId, String originalBoardName) {
        String newBoardName = String.format("[이관] %s - %s",
            originalBoardName,
            LocalDate.now().format(DateTimeFormatter.ISO_DATE)
        );

        BoardCreateRequest request = BoardCreateRequest.builder()
            .boardName(newBoardName)
            .description("이관된 업무 보드")
            .defaultViewType("TABLE")
            .build();

        return boardService.createBoardForUser(userId, request);
    }
}
```

---

## 3. 백엔드 수정 컴포넌트

### 3.1 BoardController 수정

**파일 위치**: `src/main/java/com/taskflow/controller/BoardController.java`

**추가 엔드포인트**

| 메서드 | HTTP | URL | 설명 |
|--------|------|-----|------|
| getBoardList() | GET | /api/boards/list | 보드 목록 (소유/공유 분리) |
| updateBoardOrder() | PUT | /api/boards/{id}/order | 보드 순서 변경 |
| deleteBoardWithTransfer() | DELETE | /api/boards/{id}/with-transfer | 보드 삭제 (이관 포함) |
| getTransferPreview() | GET | /api/boards/{id}/transfer-preview | 이관 미리보기 |
| updateBoardSharePermission() | PUT | /api/boards/{id}/shares/{userId} | 공유 권한 변경 |

```java
@RestController
@RequestMapping("/api/boards")
@RequiredArgsConstructor
public class BoardController {
    // 기존 메서드...

    // 신규 메서드
    @GetMapping("/list")
    public ApiResponse<BoardListResponse> getBoardList();

    @PutMapping("/{id}/order")
    public ApiResponse<BoardOrderResponse> updateBoardOrder(
        @PathVariable Long id,
        @RequestBody @Valid BoardOrderRequest request
    );

    @DeleteMapping("/{id}/with-transfer")
    public ApiResponse<TransferResultResponse> deleteBoardWithTransfer(
        @PathVariable Long id,
        @RequestBody(required = false) BoardDeleteRequest request
    );

    @GetMapping("/{id}/transfer-preview")
    public ApiResponse<TransferPreviewResponse> getTransferPreview(@PathVariable Long id);

    @PutMapping("/{id}/shares/{userId}")
    public ApiResponse<BoardShareResponse> updateBoardSharePermission(
        @PathVariable Long id,
        @PathVariable Long userId,
        @RequestBody @Valid BoardShareUpdateRequest request
    );
}
```

---

### 3.2 BoardService 수정

**파일 위치**: `src/main/java/com/taskflow/service/BoardService.java`

**추가 메서드**

| 메서드 | 파라미터 | 반환 | 설명 |
|--------|---------|------|------|
| getBoardList() | Long userId | BoardListResponse | 소유/공유 분리 목록 |
| updateBoardOrder() | Long boardId, int sortOrder | void | 순서 변경 |
| deleteBoardWithTransfer() | Long boardId, BoardDeleteRequest | TransferResultResponse | 이관 삭제 |
| getTransferPreview() | Long boardId | TransferPreviewResponse | 이관 미리보기 |
| updateBoardSharePermission() | Long boardId, Long userId, String permission | BoardShareResponse | 권한 변경 |
| getUserPermission() | Long boardId, Long userId | String | 권한 조회 |
| canEdit() | Long boardId, Long userId | boolean | 편집 가능 확인 |
| canDelete() | Long boardId, Long userId | boolean | 삭제 가능 확인 |

```java
@Service
@RequiredArgsConstructor
public class BoardService {
    private final BoardMapper boardMapper;
    private final BoardShareMapper boardShareMapper;
    private final ItemMapper itemMapper;
    private final TransferService transferService;
    private final AuditLogService auditLogService;

    // 추가 메서드
    public BoardListResponse getBoardList(Long userId) {
        List<Board> ownedBoards = boardMapper.selectOwnedBoards(userId);
        List<Board> sharedBoards = boardMapper.selectSharedBoards(userId);

        return BoardListResponse.builder()
            .ownedBoards(ownedBoards.stream().map(this::toResponse).toList())
            .sharedBoards(sharedBoards.stream().map(b -> toSharedResponse(b, userId)).toList())
            .totalOwned(ownedBoards.size())
            .totalShared(sharedBoards.size())
            .build();
    }

    @Transactional
    public TransferResultResponse deleteBoardWithTransfer(Long boardId, BoardDeleteRequest request) {
        // 1. 권한 검증
        Long currentUserId = SecurityUtil.getCurrentUserId();
        if (!canDelete(boardId, currentUserId)) {
            throw new BusinessException(ErrorCode.BOARD_DELETE_DENIED);
        }

        // 2. 이관 대상 확인
        TransferPreviewResponse preview = getTransferPreview(boardId);

        // 3. 이관 실행 (필요시)
        TransferResultResponse result;
        if (preview.getPendingCount() > 0) {
            if (request == null || request.getTransferToUserId() == null) {
                throw new BusinessException(ErrorCode.BOARD_TRANSFER_REQUIRED);
            }
            result = transferService.transferItems(
                boardId,
                request.getTransferToUserId(),
                request.getTransferReason(),
                currentUserId
            );
        } else {
            result = TransferResultResponse.empty(boardId);
        }

        // 4. 보드 논리 삭제
        Board board = boardMapper.selectBoardById(boardId);
        boardMapper.updateUseYn(boardId, "N", currentUserId);

        // 5. 감사 로그
        auditLogService.logBoardDelete(boardId, board, currentUserId);

        return result;
    }
}
```

---

### 3.3 BoardShareMapper 수정

**파일 위치**: `src/main/java/com/taskflow/mapper/BoardShareMapper.java`

**추가 메서드**

| 메서드 | 설명 |
|--------|------|
| updatePermissionByBoardAndUser(Long boardId, Long userId, String permission, Long updatedBy) | 권한 변경 |

**XML 추가 내용**

```xml
<update id="updatePermissionByBoardAndUser">
    UPDATE TB_BOARD_SHARE
    SET PERMISSION = #{permission},
        UPDATED_AT = NOW(),
        UPDATED_BY = #{updatedBy}
    WHERE BOARD_ID = #{boardId}
      AND USER_ID = #{userId}
</update>
```

---

## 4. 프론트엔드 신규 컴포넌트

### 4.1 Views

#### 4.1.1 BoardsView.vue

**파일 위치**: `src/views/BoardsView.vue`

보드 관리 페이지

| 섹션 | 설명 |
|------|------|
| 보드 목록 (내 보드) | 소유한 보드 목록, 드래그 정렬 |
| 보드 목록 (공유받은 보드) | 공유받은 보드 목록 |
| 보드 생성 모달 | 새 보드 생성 폼 |
| 보드 수정 모달 | 보드 정보 수정 폼 |
| 보드 삭제/이관 모달 | 이관 대상 선택 및 삭제 확인 |
| 공유 관리 모달 | 공유 사용자 관리 |

```vue
<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { useBoardStore } from '@/stores/board'
import { useUserStore } from '@/stores/user'

const boardStore = useBoardStore()
const userStore = useUserStore()

const showCreateModal = ref(false)
const showEditModal = ref(false)
const showDeleteModal = ref(false)
const showShareModal = ref(false)
const selectedBoard = ref<Board | null>(null)
const transferPreview = ref<TransferPreviewResponse | null>(null)

onMounted(async () => {
  await boardStore.fetchBoardList()
})

const ownedBoards = computed(() => boardStore.ownedBoards)
const sharedBoards = computed(() => boardStore.sharedBoards)

async function handleDelete(board: Board) {
  selectedBoard.value = board
  transferPreview.value = await boardStore.getTransferPreview(board.boardId)
  showDeleteModal.value = true
}

async function confirmDelete(transferToUserId?: number, reason?: string) {
  if (!selectedBoard.value) return

  await boardStore.deleteBoardWithTransfer(selectedBoard.value.boardId, {
    transferToUserId,
    transferReason: reason
  })

  showDeleteModal.value = false
  selectedBoard.value = null
}
</script>

<template>
  <div class="p-4">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-xl font-semibold">보드 관리</h1>
      <button @click="showCreateModal = true" class="btn-primary">
        + 새 보드
      </button>
    </div>

    <!-- 내 보드 -->
    <section class="mb-8">
      <h2 class="text-lg font-medium mb-3">내 보드</h2>
      <BoardList
        :boards="ownedBoards"
        :is-owner="true"
        @edit="handleEdit"
        @delete="handleDelete"
        @share="handleShare"
        @reorder="handleReorder"
      />
    </section>

    <!-- 공유받은 보드 -->
    <section v-if="sharedBoards.length > 0">
      <h2 class="text-lg font-medium mb-3">공유받은 보드</h2>
      <BoardList
        :boards="sharedBoards"
        :is-owner="false"
      />
    </section>

    <!-- 모달들 -->
    <BoardCreateModal v-model="showCreateModal" />
    <BoardEditModal v-model="showEditModal" :board="selectedBoard" />
    <BoardDeleteModal
      v-model="showDeleteModal"
      :board="selectedBoard"
      :preview="transferPreview"
      @confirm="confirmDelete"
    />
    <BoardShareModal v-model="showShareModal" :board="selectedBoard" />
  </div>
</template>
```

---

### 4.2 Types

#### 4.2.1 share.ts

**파일 위치**: `src/types/share.ts`

```typescript
// 업무 공유
export interface ItemShare {
  itemShareId: number
  itemId: number
  userId: number
  userName?: string
  username?: string
  departmentName?: string
  permission: SharePermission
  createdAt: string
  createdByName?: string
  updatedAt?: string
}

export interface ItemShareRequest {
  userId: number
  permission: SharePermission
}

export interface ItemShareUpdateRequest {
  permission: SharePermission
}

export type SharePermission = 'VIEW' | 'EDIT' | 'FULL'

// 감사 로그
export interface AuditLog {
  logId: number
  targetType: AuditTargetType
  targetId: number
  targetName?: string
  action: AuditAction
  actorId: number
  actorName?: string
  description?: string
  beforeData?: object
  afterData?: object
  relatedUserId?: number
  relatedUserName?: string
  ipAddress?: string
  createdAt: string
}

export type AuditTargetType = 'BOARD' | 'ITEM' | 'BOARD_SHARE' | 'ITEM_SHARE'
export type AuditAction = 'CREATE' | 'UPDATE' | 'DELETE' | 'TRANSFER' | 'SHARE' | 'UNSHARE' | 'PERMISSION_CHANGE'

export interface AuditLogSearchCondition {
  targetType?: AuditTargetType
  action?: AuditAction
  actorId?: number
  startDate?: string
  endDate?: string
}
```

---

### 4.3 API

#### 4.3.1 share.ts

**파일 위치**: `src/api/share.ts`

```typescript
import { get, post, put, del } from './client'
import type { ApiResponse, PageResponse } from '@/types/api'
import type {
  ItemShare,
  ItemShareRequest,
  ItemShareUpdateRequest,
  AuditLog,
  AuditLogSearchCondition
} from '@/types/share'

// 업무 공유 API
export const itemShareApi = {
  // 업무 공유 목록 조회
  getItemShares(itemId: number): Promise<ApiResponse<ItemShare[]>> {
    return get<ItemShare[]>(`/items/${itemId}/shares`)
  },

  // 업무 공유 추가
  addItemShare(itemId: number, data: ItemShareRequest): Promise<ApiResponse<ItemShare>> {
    return post<ItemShare>(`/items/${itemId}/shares`, data)
  },

  // 업무 공유 권한 변경
  updateItemSharePermission(
    itemId: number,
    userId: number,
    data: ItemShareUpdateRequest
  ): Promise<ApiResponse<ItemShare>> {
    return put<ItemShare>(`/items/${itemId}/shares/${userId}`, data)
  },

  // 업무 공유 제거
  removeItemShare(itemId: number, userId: number): Promise<ApiResponse<void>> {
    return del<void>(`/items/${itemId}/shares/${userId}`)
  }
}

// 감사 로그 API
export const auditLogApi = {
  // 감사 로그 목록 조회
  getAuditLogs(
    params?: AuditLogSearchCondition & { page?: number; size?: number }
  ): Promise<ApiResponse<PageResponse<AuditLog>>> {
    return get<PageResponse<AuditLog>>('/audit-logs', { params })
  },

  // 최근 감사 로그
  getRecentAuditLogs(limit?: number): Promise<ApiResponse<AuditLog[]>> {
    return get<AuditLog[]>('/audit-logs/recent', { params: { limit } })
  },

  // 보드별 감사 로그
  getBoardAuditLogs(
    boardId: number,
    params?: { page?: number; size?: number }
  ): Promise<ApiResponse<PageResponse<AuditLog>>> {
    return get<PageResponse<AuditLog>>(`/audit-logs/boards/${boardId}`, { params })
  },

  // 업무별 감사 로그
  getItemAuditLogs(
    itemId: number,
    params?: { page?: number; size?: number }
  ): Promise<ApiResponse<PageResponse<AuditLog>>> {
    return get<PageResponse<AuditLog>>(`/audit-logs/items/${itemId}`, { params })
  }
}
```

---

## 5. 프론트엔드 수정 컴포넌트

### 5.1 Types 수정

#### 5.1.1 board.ts 수정

**파일 위치**: `src/types/board.ts`

**추가 타입**

```typescript
// 권한 타입 변경
export type BoardPermission = 'VIEW' | 'EDIT' | 'FULL' | 'OWNER'

// 기존 Board 타입 확장
export interface Board {
  // 기존 필드...
  sortOrder?: number
  color?: string
  defaultViewType?: ViewType
  ownerYn?: string
  permission?: BoardPermission
  activeItemCount?: number
  shareCount?: number
}

// 신규 응답 타입
export interface BoardListResponse {
  ownedBoards: Board[]
  sharedBoards: Board[]
  totalOwned: number
  totalShared: number
}

export interface TransferPreviewResponse {
  boardId: number
  boardName: string
  totalItems: number
  completedItems: number
  deletedItems: number
  pendingCount: number
  pendingItems: PendingItem[]
}

export interface PendingItem {
  itemId: number
  content: string
  status: string
  priority: string
  assigneeId?: number
  assigneeName?: string
  createdAt: string
}

export interface TransferResultResponse {
  deletedBoardId: number
  deletedBoardName: string
  transferredItems: number
  transferredToUserId?: number
  transferredToUserName?: string
  newBoardId?: number
  newBoardName?: string
}

// 신규 요청 타입
export interface BoardOrderRequest {
  sortOrder: number
}

export interface BoardDeleteRequest {
  transferToUserId?: number
  transferReason?: string
}

export interface BoardShareUpdateRequest {
  permission: BoardPermission
}
```

---

### 5.2 API 수정

#### 5.2.1 board.ts 수정

**파일 위치**: `src/api/board.ts`

**추가 함수**

```typescript
// 보드 목록 (소유/공유 분리)
getBoardList(): Promise<ApiResponse<BoardListResponse>> {
  return get<BoardListResponse>('/boards/list')
}

// 보드 순서 변경
updateBoardOrder(boardId: number, data: BoardOrderRequest): Promise<ApiResponse<Board>> {
  return put<Board>(`/boards/${boardId}/order`, data)
}

// 이관 미리보기
getTransferPreview(boardId: number): Promise<ApiResponse<TransferPreviewResponse>> {
  return get<TransferPreviewResponse>(`/boards/${boardId}/transfer-preview`)
}

// 보드 삭제 (이관 포함)
deleteBoardWithTransfer(
  boardId: number,
  data?: BoardDeleteRequest
): Promise<ApiResponse<TransferResultResponse>> {
  return del<TransferResultResponse>(`/boards/${boardId}/with-transfer`, data)
}

// 공유 권한 변경
updateBoardSharePermission(
  boardId: number,
  userId: number,
  data: BoardShareUpdateRequest
): Promise<ApiResponse<BoardShare>> {
  return put<BoardShare>(`/boards/${boardId}/shares/${userId}`, data)
}
```

---

### 5.3 Store 수정

#### 5.3.1 board.ts 수정

**파일 위치**: `src/stores/board.ts`

**추가 상태**

```typescript
// State
const ownedBoards = computed(() =>
  boards.value.filter(b => b.ownerYn === 'Y')
)
const sharedBoards = computed(() =>
  boards.value.filter(b => b.ownerYn !== 'Y')
)
```

**추가 액션**

```typescript
// 보드 목록 (소유/공유 분리)
async function fetchBoardList(): Promise<BoardListResponse | null> {
  loading.value = true
  try {
    const response = await boardApi.getBoardList()
    if (response.success && response.data) {
      const allBoards = [
        ...response.data.ownedBoards,
        ...response.data.sharedBoards
      ]
      _setBoards(allBoards)
      return response.data
    }
    return null
  } finally {
    loading.value = false
  }
}

// 보드 순서 변경
async function updateBoardOrder(boardId: number, sortOrder: number): Promise<boolean> {
  const original = boards.value.find(b => b.boardId === boardId)
  if (!original) return false

  // Optimistic Update
  _updateBoard(boardId, { sortOrder })

  try {
    const response = await boardApi.updateBoardOrder(boardId, { sortOrder })
    return response.success
  } catch {
    // Rollback
    _updateBoard(boardId, { sortOrder: original.sortOrder })
    return false
  }
}

// 이관 미리보기
async function getTransferPreview(boardId: number): Promise<TransferPreviewResponse | null> {
  try {
    const response = await boardApi.getTransferPreview(boardId)
    return response.success ? response.data : null
  } catch {
    return null
  }
}

// 보드 삭제 (이관 포함)
async function deleteBoardWithTransfer(
  boardId: number,
  data?: BoardDeleteRequest
): Promise<TransferResultResponse | null> {
  loading.value = true
  try {
    const response = await boardApi.deleteBoardWithTransfer(boardId, data)
    if (response.success) {
      _removeBoard(boardId)
      return response.data
    }
    return null
  } finally {
    loading.value = false
  }
}

// 공유 권한 변경
async function updateBoardSharePermission(
  boardId: number,
  userId: number,
  permission: string
): Promise<boolean> {
  try {
    const response = await boardApi.updateBoardSharePermission(boardId, userId, { permission })
    if (response.success) {
      // boardShares 업데이트
      const idx = boardShares.value.findIndex(s => s.userId === userId)
      if (idx !== -1) {
        boardShares.value[idx].permission = permission
      }
      return true
    }
    return false
  } catch {
    return false
  }
}
```

---

### 5.4 Router 수정

**파일 위치**: `src/router/index.ts`

**추가 라우트**

```typescript
{
  path: 'boards',
  name: 'Boards',
  component: () => import('@/views/BoardsView.vue'),
  meta: { title: '보드 관리' }
}
```

---

### 5.5 Sidebar 수정

**파일 위치**: `src/components/layout/Sidebar.vue`

**추가 메뉴**

```typescript
const menuItems = [
  // 기존 메뉴...
  { divider: true },
  { name: 'Departments', label: '부서 관리', icon: 'building' },
  { name: 'Groups', label: '그룹 관리', icon: 'folder' },
  { name: 'Boards', label: '보드 관리', icon: 'board' }  // 신규
]
```

---

## 6. 패키지 구조 변경

### 6.1 백엔드

```
com.taskflow
├── controller/
│   ├── ...기존 컨트롤러
│   ├── ItemShareController.java     [신규]
│   └── AuditLogController.java      [신규]
│
├── service/
│   ├── ...기존 서비스
│   ├── ItemShareService.java        [신규]
│   ├── AuditLogService.java         [신규]
│   └── TransferService.java         [신규]
│
├── mapper/
│   ├── ...기존 매퍼
│   ├── ItemShareMapper.java         [신규]
│   └── AuditLogMapper.java          [신규]
│
├── domain/
│   ├── ...기존 도메인
│   ├── ItemShare.java               [신규]
│   └── AuditLog.java                [신규]
│
└── dto/
    ├── board/
    │   ├── BoardListResponse.java   [신규]
    │   ├── BoardOrderRequest.java   [신규]
    │   ├── BoardDeleteRequest.java  [신규]
    │   ├── TransferPreviewResponse.java  [신규]
    │   └── TransferResultResponse.java   [신규]
    ├── share/
    │   ├── ItemShareRequest.java    [신규]
    │   ├── ItemShareResponse.java   [신규]
    │   └── ItemShareUpdateRequest.java  [신규]
    └── auditlog/
        ├── AuditLogResponse.java    [신규]
        └── AuditLogSearchCondition.java  [신규]
```

### 6.2 프론트엔드

```
src/
├── views/
│   ├── ...기존 뷰
│   └── BoardsView.vue               [신규]
│
├── api/
│   ├── ...기존 API
│   └── share.ts                     [신규]
│
├── types/
│   ├── board.ts                     [수정]
│   ├── share.ts                     [신규]
│   └── index.ts                     [수정]
│
└── stores/
    └── board.ts                     [수정]
```

---

## 7. 변경 요약

### 7.1 백엔드 파일 변경

| 구분 | 파일명 | 변경 유형 |
|------|--------|----------|
| Controller | ItemShareController.java | 신규 |
| Controller | AuditLogController.java | 신규 |
| Controller | BoardController.java | 수정 |
| Service | ItemShareService.java | 신규 |
| Service | AuditLogService.java | 신규 |
| Service | TransferService.java | 신규 |
| Service | BoardService.java | 수정 |
| Mapper | ItemShareMapper.java | 신규 |
| Mapper | AuditLogMapper.java | 신규 |
| Mapper | BoardShareMapper.java | 수정 |
| XML | ItemShareMapper.xml | 신규 |
| XML | AuditLogMapper.xml | 신규 |
| XML | BoardShareMapper.xml | 수정 |
| Domain | ItemShare.java | 신규 |
| Domain | AuditLog.java | 신규 |
| DTO | 12개 파일 | 신규 |

**백엔드 변경 합계: 21개 파일**

### 7.2 프론트엔드 파일 변경

| 구분 | 파일명 | 변경 유형 |
|------|--------|----------|
| View | BoardsView.vue | 신규 |
| Type | share.ts | 신규 |
| Type | board.ts | 수정 |
| Type | index.ts | 수정 |
| API | share.ts | 신규 |
| API | board.ts | 수정 |
| API | index.ts | 수정 |
| API | client.ts | 수정 |
| Store | board.ts | 수정 |
| Router | index.ts | 수정 |
| Component | Sidebar.vue | 수정 |

**프론트엔드 변경 합계: 11개 파일**

### 7.3 전체 요약

| 항목 | 백엔드 | 프론트엔드 | 합계 |
|------|--------|-----------|------|
| 신규 파일 | 17 | 3 | 20 |
| 수정 파일 | 4 | 8 | 12 |
| **총 변경** | **21** | **11** | **32** |

---

## 승인

| 항목 | 내용 |
|------|------|
| 문서명 | TaskFlow v1.1 컴포넌트 구조 |
| 버전 | 1.1 |
| 작성자 | - |
| 작성일 | 2024-12-21 |
| 상태 | 승인 대기 |

---

*이 문서는 v1.0 컴포넌트 구조 문서(docs/component/)를 기반으로 확장된 문서입니다.*
