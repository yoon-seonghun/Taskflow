<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.taskflow.mapper.BoardMapper">

    <!-- ============================================= -->
    <!-- Result Map -->
    <!-- ============================================= -->

    <resultMap id="BoardResultMap" type="com.taskflow.domain.Board">
        <id property="boardId" column="BOARD_ID"/>
        <result property="boardName" column="BOARD_NAME"/>
        <result property="description" column="BOARD_DESC"/>
        <result property="ownerId" column="OWNER_ID"/>
        <result property="defaultView" column="DEFAULT_VIEW"/>
        <result property="color" column="COLOR"/>
        <result property="sortOrder" column="SORT_ORDER"/>
        <result property="useYn" column="USE_YN"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="updatedBy" column="UPDATED_BY"/>
        <!-- 추가 필드 -->
        <result property="ownerName" column="OWNER_NAME"/>
        <result property="itemCount" column="ITEM_COUNT"/>
        <result property="shareCount" column="SHARE_COUNT"/>
    </resultMap>

    <!-- ============================================= -->
    <!-- 공통 SQL 조각 -->
    <!-- ============================================= -->

    <sql id="selectBoard">
        SELECT
            b.BOARD_ID,
            b.BOARD_NAME,
            b.DESCRIPTION AS BOARD_DESC,
            b.OWNER_ID,
            b.DEFAULT_VIEW,
            b.COLOR,
            b.SORT_ORDER,
            b.USE_YN,
            b.CREATED_AT,
            b.CREATED_BY,
            b.UPDATED_AT,
            b.UPDATED_BY,
            u.NAME AS OWNER_NAME,
            (SELECT COUNT(*) FROM TB_ITEM i WHERE i.BOARD_ID = b.BOARD_ID) AS ITEM_COUNT,
            (SELECT COUNT(*) FROM TB_BOARD_SHARE bs WHERE bs.BOARD_ID = b.BOARD_ID) AS SHARE_COUNT
        FROM TB_BOARD b
        LEFT JOIN TB_USER u ON b.OWNER_ID = u.USER_ID
    </sql>

    <!-- ============================================= -->
    <!-- 조회 -->
    <!-- ============================================= -->

    <!-- 보드 ID로 조회 -->
    <select id="findById" resultMap="BoardResultMap">
        <include refid="selectBoard"/>
        WHERE b.BOARD_ID = #{boardId}
    </select>

    <!-- 사용자가 소유한 보드 목록 조회 -->
    <select id="findByOwnerId" resultMap="BoardResultMap">
        <include refid="selectBoard"/>
        WHERE b.OWNER_ID = #{ownerId}
        <if test="useYn != null and useYn != ''">
            AND b.USE_YN = #{useYn}
        </if>
        ORDER BY b.BOARD_NAME
    </select>

    <!-- 사용자가 접근 가능한 모든 보드 목록 조회 (소유 + 공유) -->
    <select id="findAccessibleByUserId" resultMap="BoardResultMap">
        <include refid="selectBoard"/>
        WHERE (
            b.OWNER_ID = #{userId}
            OR EXISTS (
                SELECT 1 FROM TB_BOARD_SHARE bs
                WHERE bs.BOARD_ID = b.BOARD_ID AND bs.USER_ID = #{userId}
            )
        )
        <if test="useYn != null and useYn != ''">
            AND b.USE_YN = #{useYn}
        </if>
        ORDER BY b.BOARD_NAME
    </select>

    <!-- 전체 보드 목록 조회 (관리자용) -->
    <select id="findAll" resultMap="BoardResultMap">
        <include refid="selectBoard"/>
        <where>
            <if test="useYn != null and useYn != ''">
                b.USE_YN = #{useYn}
            </if>
        </where>
        ORDER BY b.BOARD_NAME
    </select>

    <!-- 사용자가 특정 보드에 접근 가능한지 확인 -->
    <select id="hasAccess" resultType="boolean">
        SELECT EXISTS (
            SELECT 1 FROM TB_BOARD b
            WHERE b.BOARD_ID = #{boardId}
              AND (
                  b.OWNER_ID = #{userId}
                  OR EXISTS (
                      SELECT 1 FROM TB_BOARD_SHARE bs
                      WHERE bs.BOARD_ID = b.BOARD_ID AND bs.USER_ID = #{userId}
                  )
              )
        )
    </select>

    <!-- 최대 정렬 순서 조회 -->
    <select id="getMaxSortOrder" resultType="java.lang.Integer">
        SELECT COALESCE(MAX(SORT_ORDER), 0) FROM TB_BOARD
        <where>
            <if test="ownerId != null">
                OWNER_ID = #{ownerId}
            </if>
        </where>
    </select>

    <!-- 보드에 아이템이 있는지 확인 -->
    <select id="hasItems" resultType="boolean">
        SELECT EXISTS (
            SELECT 1 FROM TB_ITEM WHERE BOARD_ID = #{boardId}
        )
    </select>

    <!-- ============================================= -->
    <!-- 등록/수정/삭제 -->
    <!-- ============================================= -->

    <!-- 보드 등록 -->
    <insert id="insert" parameterType="com.taskflow.domain.Board" useGeneratedKeys="true" keyProperty="boardId">
        INSERT INTO TB_BOARD (
            BOARD_NAME,
            DESCRIPTION,
            OWNER_ID,
            DEFAULT_VIEW,
            COLOR,
            SORT_ORDER,
            USE_YN,
            CREATED_BY
        ) VALUES (
            #{boardName},
            #{description},
            #{ownerId},
            COALESCE(#{defaultView}, 'TABLE'),
            #{color},
            COALESCE(#{sortOrder}, 0),
            COALESCE(#{useYn}, 'Y'),
            #{createdBy}
        )
    </insert>

    <!-- 보드 수정 -->
    <update id="update" parameterType="com.taskflow.domain.Board">
        UPDATE TB_BOARD
        SET
            BOARD_NAME = #{boardName},
            DESCRIPTION = #{description},
            DEFAULT_VIEW = #{defaultView},
            COLOR = #{color},
            SORT_ORDER = COALESCE(#{sortOrder}, SORT_ORDER),
            USE_YN = #{useYn},
            UPDATED_BY = #{updatedBy},
            UPDATED_AT = CURRENT_TIMESTAMP
        WHERE BOARD_ID = #{boardId}
    </update>

    <!-- 보드 삭제 (물리 삭제) -->
    <delete id="delete">
        DELETE FROM TB_BOARD
        WHERE BOARD_ID = #{boardId}
    </delete>

    <!-- 보드 비활성화 (논리 삭제) -->
    <update id="deactivate">
        UPDATE TB_BOARD
        SET
            USE_YN = 'N',
            UPDATED_BY = #{updatedBy},
            UPDATED_AT = CURRENT_TIMESTAMP
        WHERE BOARD_ID = #{boardId}
    </update>

    <!-- ============================================= -->
    <!-- 보드 관리 추가 쿼리 -->
    <!-- ============================================= -->

    <!-- 소유한 보드 목록 조회 (정렬 순서 포함) -->
    <select id="findOwnedBoards" resultMap="BoardResultMap">
        <include refid="selectBoard"/>
        WHERE b.OWNER_ID = #{userId}
          AND b.USE_YN = 'Y'
        ORDER BY b.SORT_ORDER, b.CREATED_AT DESC
    </select>

    <!-- 공유받은 보드 목록 조회 (권한 정보 포함) -->
    <select id="findSharedBoards" resultType="map">
        SELECT
            b.BOARD_ID,
            b.BOARD_NAME,
            b.DESCRIPTION AS BOARD_DESC,
            b.OWNER_ID,
            b.DEFAULT_VIEW,
            b.COLOR,
            bs.PERMISSION,
            u.NAME AS OWNER_NAME,
            (SELECT COUNT(*) FROM TB_ITEM i WHERE i.BOARD_ID = b.BOARD_ID) AS ITEM_COUNT
        FROM TB_BOARD b
        INNER JOIN TB_BOARD_SHARE bs ON b.BOARD_ID = bs.BOARD_ID
        LEFT JOIN TB_USER u ON b.OWNER_ID = u.USER_ID
        WHERE bs.USER_ID = #{userId}
          AND b.USE_YN = 'Y'
        ORDER BY b.BOARD_NAME
    </select>

    <!-- 미완료 업무 수 조회 -->
    <select id="countPendingItems" resultType="int">
        SELECT COUNT(*)
        FROM TB_ITEM
        WHERE BOARD_ID = #{boardId}
          AND STATUS NOT IN ('COMPLETED', 'DELETED')
    </select>

    <!-- 미완료 업무 목록 조회 -->
    <select id="findPendingItems" resultType="map">
        SELECT
            i.ITEM_ID,
            i.CONTENT AS TITLE,
            i.STATUS,
            i.PRIORITY,
            u.NAME AS ASSIGNEE_NAME
        FROM TB_ITEM i
        LEFT JOIN TB_USER u ON i.ASSIGNEE_ID = u.USER_ID
        WHERE i.BOARD_ID = #{boardId}
          AND i.STATUS NOT IN ('COMPLETED', 'DELETED')
        ORDER BY i.CREATED_AT
    </select>

    <!-- 보드 순서 변경 -->
    <update id="updateSortOrder">
        UPDATE TB_BOARD
        SET SORT_ORDER = #{sortOrder},
            UPDATED_BY = #{updatedBy},
            UPDATED_AT = CURRENT_TIMESTAMP
        WHERE BOARD_ID = #{boardId}
    </update>

    <!-- 사용자의 보드 권한 조회 (OWNER 또는 공유 권한) -->
    <select id="getUserPermission" resultType="String">
        SELECT
            CASE
                WHEN b.OWNER_ID = #{userId} THEN 'OWNER'
                ELSE bs.PERMISSION
            END AS PERMISSION
        FROM TB_BOARD b
        LEFT JOIN TB_BOARD_SHARE bs ON b.BOARD_ID = bs.BOARD_ID AND bs.USER_ID = #{userId}
        WHERE b.BOARD_ID = #{boardId}
          AND (b.OWNER_ID = #{userId} OR bs.USER_ID = #{userId})
    </select>

</mapper>
