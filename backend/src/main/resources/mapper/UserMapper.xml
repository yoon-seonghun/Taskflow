<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.taskflow.mapper.UserMapper">

    <!-- ============================================= -->
    <!-- Result Map -->
    <!-- ============================================= -->

    <resultMap id="UserResultMap" type="com.taskflow.domain.User">
        <id property="userId" column="USER_ID"/>
        <result property="username" column="USERNAME"/>
        <result property="password" column="PASSWORD"/>
        <result property="name" column="NAME"/>
        <result property="email" column="EMAIL"/>
        <result property="departmentId" column="DEPARTMENT_ID"/>
        <result property="useYn" column="USE_YN"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="updatedBy" column="UPDATED_BY"/>
        <result property="lastLoginAt" column="LAST_LOGIN_AT"/>
        <!-- 조인 필드 -->
        <result property="departmentName" column="DEPARTMENT_NAME"/>
        <result property="departmentCode" column="DEPARTMENT_CODE"/>
    </resultMap>

    <!-- ============================================= -->
    <!-- 공통 SQL 조각 -->
    <!-- ============================================= -->

    <sql id="selectUser">
        SELECT
            u.USER_ID,
            u.USERNAME,
            u.PASSWORD,
            u.NAME,
            u.EMAIL,
            u.DEPARTMENT_ID,
            u.USE_YN,
            u.CREATED_AT,
            u.CREATED_BY,
            u.UPDATED_AT,
            u.UPDATED_BY,
            u.LAST_LOGIN_AT,
            d.DEPARTMENT_NAME,
            d.DEPARTMENT_CODE
        FROM TB_USER u
        LEFT JOIN TB_DEPARTMENT d ON u.DEPARTMENT_ID = d.DEPARTMENT_ID
    </sql>

    <sql id="whereCondition">
        <where>
            <if test="request.keyword != null and request.keyword != ''">
                AND (
                    u.USERNAME LIKE CONCAT('%', #{request.keyword}, '%')
                    OR u.NAME LIKE CONCAT('%', #{request.keyword}, '%')
                )
            </if>
            <if test="request.departmentId != null">
                AND u.DEPARTMENT_ID = #{request.departmentId}
            </if>
            <if test="request.useYn != null and request.useYn != ''">
                AND u.USE_YN = #{request.useYn}
            </if>
        </where>
    </sql>

    <!-- ============================================= -->
    <!-- 조회 -->
    <!-- ============================================= -->

    <!-- 사용자 ID로 조회 -->
    <select id="findById" resultMap="UserResultMap">
        <include refid="selectUser"/>
        WHERE u.USER_ID = #{userId}
    </select>

    <!-- 로그인 아이디로 조회 -->
    <select id="findByUsername" resultMap="UserResultMap">
        <include refid="selectUser"/>
        WHERE u.USERNAME = #{username}
    </select>

    <!-- 사용자 목록 조회 (검색/필터/페이징) -->
    <select id="findAll" resultMap="UserResultMap">
        <include refid="selectUser"/>
        <include refid="whereCondition"/>
        ORDER BY
        <choose>
            <when test="request.sortField != null and request.sortField != ''">
                <choose>
                    <when test="request.sortField == 'userId'">u.USER_ID</when>
                    <when test="request.sortField == 'username'">u.USERNAME</when>
                    <when test="request.sortField == 'name'">u.NAME</when>
                    <when test="request.sortField == 'createdAt'">u.CREATED_AT</when>
                    <otherwise>u.CREATED_AT</otherwise>
                </choose>
                <if test="request.descending">DESC</if>
                <if test="!request.descending">ASC</if>
            </when>
            <otherwise>
                u.CREATED_AT DESC
            </otherwise>
        </choose>
        LIMIT #{request.limit} OFFSET #{request.offset}
    </select>

    <!-- 사용자 총 개수 조회 -->
    <select id="countAll" resultType="long">
        SELECT COUNT(*)
        FROM TB_USER u
        <include refid="whereCondition"/>
    </select>

    <!-- 부서별 사용자 목록 조회 -->
    <select id="findByDepartmentId" resultMap="UserResultMap">
        <include refid="selectUser"/>
        WHERE u.DEPARTMENT_ID = #{departmentId}
          AND u.USE_YN = 'Y'
        ORDER BY u.NAME ASC
    </select>

    <!-- 아이디 중복 확인 -->
    <select id="existsByUsername" resultType="boolean">
        SELECT EXISTS (
            SELECT 1 FROM TB_USER WHERE USERNAME = #{username}
        )
    </select>

    <!-- 아이디 중복 확인 (자신 제외) -->
    <select id="existsByUsernameAndUserIdNot" resultType="boolean">
        SELECT EXISTS (
            SELECT 1 FROM TB_USER
            WHERE USERNAME = #{username}
              AND USER_ID != #{userId}
        )
    </select>

    <!-- ============================================= -->
    <!-- 등록/수정/삭제 -->
    <!-- ============================================= -->

    <!-- 사용자 등록 -->
    <insert id="insert" parameterType="com.taskflow.domain.User" useGeneratedKeys="true" keyProperty="userId">
        INSERT INTO TB_USER (
            USERNAME,
            PASSWORD,
            NAME,
            EMAIL,
            DEPARTMENT_ID,
            USE_YN,
            CREATED_BY
        ) VALUES (
            #{username},
            #{password},
            #{name},
            #{email},
            #{departmentId},
            #{useYn},
            #{createdBy}
        )
    </insert>

    <!-- 사용자 정보 수정 -->
    <update id="update" parameterType="com.taskflow.domain.User">
        UPDATE TB_USER
        SET
            NAME = #{name},
            EMAIL = #{email},
            DEPARTMENT_ID = #{departmentId},
            USE_YN = #{useYn},
            UPDATED_BY = #{updatedBy},
            UPDATED_AT = CURRENT_TIMESTAMP
        WHERE USER_ID = #{userId}
    </update>

    <!-- 비밀번호 변경 -->
    <update id="updatePassword">
        UPDATE TB_USER
        SET
            PASSWORD = #{password},
            UPDATED_BY = #{updatedBy},
            UPDATED_AT = CURRENT_TIMESTAMP
        WHERE USER_ID = #{userId}
    </update>

    <!-- 사용자 삭제 (물리 삭제) -->
    <delete id="delete">
        DELETE FROM TB_USER
        WHERE USER_ID = #{userId}
    </delete>

    <!-- 사용자 비활성화 (논리 삭제) -->
    <update id="deactivate">
        UPDATE TB_USER
        SET
            USE_YN = 'N',
            UPDATED_BY = #{updatedBy},
            UPDATED_AT = CURRENT_TIMESTAMP
        WHERE USER_ID = #{userId}
    </update>

    <!-- 마지막 로그인 일시 업데이트 -->
    <update id="updateLastLoginAt">
        UPDATE TB_USER
        SET LAST_LOGIN_AT = CURRENT_TIMESTAMP
        WHERE USER_ID = #{userId}
    </update>

</mapper>
