<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.taskflow.mapper.PropertyOptionMapper">

    <!-- ============================================= -->
    <!-- Result Map -->
    <!-- ============================================= -->

    <resultMap id="PropertyOptionResultMap" type="com.taskflow.domain.PropertyOption">
        <id property="optionId" column="OPTION_ID"/>
        <result property="propertyId" column="PROPERTY_ID"/>
        <result property="optionName" column="OPTION_NAME"/>
        <result property="color" column="COLOR"/>
        <result property="sortOrder" column="SORT_ORDER"/>
        <result property="useYn" column="USE_YN"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="updatedBy" column="UPDATED_BY"/>
        <!-- 조인 필드 -->
        <result property="propertyName" column="PROPERTY_NAME"/>
        <result property="propertyType" column="PROPERTY_TYPE"/>
        <result property="boardId" column="BOARD_ID"/>
        <result property="usageCount" column="USAGE_COUNT"/>
    </resultMap>

    <!-- ============================================= -->
    <!-- 공통 SQL 조각 -->
    <!-- ============================================= -->

    <sql id="selectPropertyOption">
        SELECT
            o.OPTION_ID,
            o.PROPERTY_ID,
            o.OPTION_LABEL AS OPTION_NAME,
            o.COLOR,
            o.SORT_ORDER,
            o.USE_YN,
            o.CREATED_AT,
            o.CREATED_BY,
            o.UPDATED_AT,
            o.UPDATED_BY,
            p.PROPERTY_NAME,
            p.PROPERTY_TYPE,
            p.BOARD_ID,
            (SELECT COUNT(*) FROM TB_ITEM_PROPERTY v
             WHERE v.PROPERTY_ID = o.PROPERTY_ID
               AND (v.VALUE_TEXT = CAST(o.OPTION_ID AS CHAR) COLLATE utf8mb4_unicode_ci
                    OR v.VALUE_TEXT LIKE CONCAT('%,', o.OPTION_ID, ',%') COLLATE utf8mb4_unicode_ci
                    OR v.VALUE_TEXT LIKE CONCAT(o.OPTION_ID, ',%') COLLATE utf8mb4_unicode_ci
                    OR v.VALUE_TEXT LIKE CONCAT('%,', o.OPTION_ID) COLLATE utf8mb4_unicode_ci
                    OR v.VALUE_OPTION_ID = o.OPTION_ID)
            ) AS USAGE_COUNT
        FROM TB_PROPERTY_OPTION o
        INNER JOIN TB_PROPERTY_DEF p ON o.PROPERTY_ID = p.PROPERTY_ID
    </sql>

    <!-- ============================================= -->
    <!-- 조회 -->
    <!-- ============================================= -->

    <!-- 옵션 ID로 조회 -->
    <select id="findById" resultMap="PropertyOptionResultMap">
        <include refid="selectPropertyOption"/>
        WHERE o.OPTION_ID = #{optionId}
    </select>

    <!-- 속성별 옵션 목록 조회 -->
    <select id="findByPropertyId" resultMap="PropertyOptionResultMap">
        <include refid="selectPropertyOption"/>
        WHERE o.PROPERTY_ID = #{propertyId}
        <if test="useYn != null and useYn != ''">
            AND o.USE_YN = #{useYn}
        </if>
        ORDER BY o.SORT_ORDER, o.OPTION_LABEL
    </select>

    <!-- 속성 내 옵션명으로 조회 -->
    <select id="findByPropertyIdAndLabel" resultMap="PropertyOptionResultMap">
        <include refid="selectPropertyOption"/>
        WHERE o.PROPERTY_ID = #{propertyId}
          AND o.OPTION_LABEL = #{optionLabel}
    </select>

    <!-- 속성 내 옵션명 중복 확인 -->
    <select id="existsByPropertyIdAndLabel" resultType="boolean">
        SELECT EXISTS (
            SELECT 1 FROM TB_PROPERTY_OPTION
            WHERE PROPERTY_ID = #{propertyId}
              AND OPTION_LABEL = #{optionLabel}
        )
    </select>

    <!-- 속성 내 옵션명 중복 확인 (자신 제외) -->
    <select id="existsByPropertyIdAndLabelAndIdNot" resultType="boolean">
        SELECT EXISTS (
            SELECT 1 FROM TB_PROPERTY_OPTION
            WHERE PROPERTY_ID = #{propertyId}
              AND OPTION_LABEL = #{optionLabel}
              AND OPTION_ID != #{optionId}
        )
    </select>

    <!-- 속성 내 최대 정렬 순서 조회 -->
    <select id="getMaxSortOrder" resultType="java.lang.Integer">
        SELECT COALESCE(MAX(SORT_ORDER), 0)
        FROM TB_PROPERTY_OPTION
        WHERE PROPERTY_ID = #{propertyId}
    </select>

    <!-- 옵션이 아이템에 사용 중인지 확인 -->
    <select id="isOptionInUse" resultType="boolean">
        SELECT EXISTS (
            SELECT 1 FROM TB_ITEM_PROPERTY v
            WHERE v.VALUE_OPTION_ID = #{optionId}
               OR v.VALUE_TEXT = CAST(#{optionId} AS CHAR) COLLATE utf8mb4_unicode_ci
               OR v.VALUE_TEXT LIKE CONCAT('%,', #{optionId}, ',%') COLLATE utf8mb4_unicode_ci
               OR v.VALUE_TEXT LIKE CONCAT(#{optionId}, ',%') COLLATE utf8mb4_unicode_ci
               OR v.VALUE_TEXT LIKE CONCAT('%,', #{optionId}) COLLATE utf8mb4_unicode_ci
        )
    </select>

    <!-- 옵션 사용 횟수 조회 -->
    <select id="getUsageCount" resultType="int">
        SELECT COUNT(*) FROM TB_ITEM_PROPERTY v
        WHERE v.VALUE_OPTION_ID = #{optionId}
           OR v.VALUE_TEXT = CAST(#{optionId} AS CHAR) COLLATE utf8mb4_unicode_ci
           OR v.VALUE_TEXT LIKE CONCAT('%,', #{optionId}, ',%') COLLATE utf8mb4_unicode_ci
           OR v.VALUE_TEXT LIKE CONCAT(#{optionId}, ',%') COLLATE utf8mb4_unicode_ci
           OR v.VALUE_TEXT LIKE CONCAT('%,', #{optionId}) COLLATE utf8mb4_unicode_ci
    </select>

    <!-- ============================================= -->
    <!-- 등록/수정/삭제 -->
    <!-- ============================================= -->

    <!-- 옵션 등록 -->
    <insert id="insert" parameterType="com.taskflow.domain.PropertyOption" useGeneratedKeys="true" keyProperty="optionId">
        INSERT INTO TB_PROPERTY_OPTION (
            PROPERTY_ID,
            OPTION_LABEL,
            COLOR,
            SORT_ORDER,
            USE_YN,
            CREATED_BY
        ) VALUES (
            #{propertyId},
            #{optionName},
            #{color},
            #{sortOrder},
            #{useYn},
            #{createdBy}
        )
    </insert>

    <!-- 옵션 수정 -->
    <update id="update" parameterType="com.taskflow.domain.PropertyOption">
        UPDATE TB_PROPERTY_OPTION
        SET
            OPTION_LABEL = #{optionName},
            COLOR = #{color},
            SORT_ORDER = #{sortOrder},
            USE_YN = #{useYn},
            UPDATED_BY = #{updatedBy},
            UPDATED_AT = CURRENT_TIMESTAMP
        WHERE OPTION_ID = #{optionId}
    </update>

    <!-- 옵션 삭제 -->
    <delete id="delete">
        DELETE FROM TB_PROPERTY_OPTION
        WHERE OPTION_ID = #{optionId}
    </delete>

    <!-- 속성의 모든 옵션 삭제 -->
    <delete id="deleteByPropertyId">
        DELETE FROM TB_PROPERTY_OPTION
        WHERE PROPERTY_ID = #{propertyId}
    </delete>

</mapper>
