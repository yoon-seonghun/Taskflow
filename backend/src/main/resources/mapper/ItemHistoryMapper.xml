<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.taskflow.mapper.ItemHistoryMapper">

    <!-- ============================================= -->
    <!-- Result Map -->
    <!-- ============================================= -->

    <resultMap id="ItemHistoryResultMap" type="com.taskflow.domain.ItemHistory">
        <id property="itemId" column="ITEM_ID"/>
        <result property="boardId" column="BOARD_ID"/>
        <result property="title" column="TITLE"/>
        <result property="result" column="RESULT"/>
        <result property="workerId" column="WORKER_ID"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="startTime" column="START_TIME"/>
        <result property="completedAt" column="COMPLETED_AT"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="deletedAt" column="DELETED_AT"/>
        <result property="previousStatus" column="PREVIOUS_STATUS"/>
        <!-- 조인 필드 -->
        <result property="boardName" column="BOARD_NAME"/>
        <result property="workerName" column="WORKER_NAME"/>
        <result property="createdByName" column="CREATED_BY_NAME"/>
    </resultMap>

    <!-- ============================================= -->
    <!-- 공통 SQL 조각 -->
    <!-- ============================================= -->

    <sql id="selectItemHistory">
        SELECT
            i.ITEM_ID,
            i.BOARD_ID,
            i.CONTENT AS TITLE,
            i.STATUS AS RESULT,
            CASE
                WHEN i.STATUS = 'COMPLETED' THEN i.COMPLETED_BY
                WHEN i.STATUS = 'DELETED' THEN i.DELETED_BY
            END AS WORKER_ID,
            i.CREATED_AT,
            i.START_TIME,
            i.END_TIME AS COMPLETED_AT,
            i.UPDATED_AT,
            i.DELETED_AT,
            i.PREVIOUS_STATUS,
            b.BOARD_NAME,
            CASE
                WHEN i.STATUS = 'COMPLETED' THEN uc.NAME
                WHEN i.STATUS = 'DELETED' THEN ud.NAME
            END AS WORKER_NAME,
            ucr.NAME AS CREATED_BY_NAME
        FROM TB_ITEM i
        INNER JOIN TB_BOARD b ON i.BOARD_ID = b.BOARD_ID
        LEFT JOIN TB_USER uc ON i.COMPLETED_BY = uc.USER_ID
        LEFT JOIN TB_USER ud ON i.DELETED_BY = ud.USER_ID
        LEFT JOIN TB_USER ucr ON i.CREATED_BY = ucr.USER_ID
    </sql>

    <sql id="historyConditions">
        WHERE i.STATUS IN ('COMPLETED', 'DELETED')
        <if test="request.boardId != null">
            AND i.BOARD_ID = #{request.boardId}
        </if>
        <if test="request.result != null and request.result != ''">
            AND i.STATUS = #{request.result}
        </if>
        <if test="request.workerId != null">
            AND i.UPDATED_BY = #{request.workerId}
        </if>
        <!-- 날짜 필터: END_TIME이 NULL인 경우 UPDATED_AT 또는 CREATED_AT으로 대체 -->
        <if test="request.startDate != null">
            AND (
                (i.STATUS = 'COMPLETED' AND COALESCE(i.END_TIME, i.UPDATED_AT, i.CREATED_AT) >= #{request.startDate})
                OR (i.STATUS = 'DELETED' AND COALESCE(i.DELETED_AT, i.UPDATED_AT, i.CREATED_AT) >= #{request.startDate})
            )
        </if>
        <if test="request.endDate != null">
            AND (
                (i.STATUS = 'COMPLETED' AND COALESCE(i.END_TIME, i.UPDATED_AT, i.CREATED_AT) &lt; DATE_ADD(#{request.endDate}, INTERVAL 1 DAY))
                OR (i.STATUS = 'DELETED' AND COALESCE(i.DELETED_AT, i.UPDATED_AT, i.CREATED_AT) &lt; DATE_ADD(#{request.endDate}, INTERVAL 1 DAY))
            )
        </if>
        <if test="request.keyword != null and request.keyword != ''">
            AND i.CONTENT LIKE CONCAT('%', #{request.keyword}, '%')
        </if>
    </sql>

    <!-- ============================================= -->
    <!-- 조회 -->
    <!-- ============================================= -->

    <!-- 작업 처리 이력 조회 -->
    <select id="findItemHistory" resultMap="ItemHistoryResultMap">
        <include refid="selectItemHistory"/>
        <include refid="historyConditions"/>
        ORDER BY
        <choose>
            <when test="request.sortField == 'title' or request.sortField == 'content'">i.CONTENT</when>
            <when test="request.sortField == 'result'">RESULT</when>
            <when test="request.sortField == 'workerName'">WORKER_NAME</when>
            <when test="request.sortField == 'createdAt'">i.CREATED_AT</when>
            <when test="request.sortField == 'startTime'">i.START_TIME</when>
            <when test="request.sortField == 'completedAt' or request.sortField == 'endTime'">i.END_TIME</when>
            <when test="request.sortField == 'updatedAt'">i.UPDATED_AT</when>
            <when test="request.sortField == 'deletedAt'">i.DELETED_AT</when>
            <otherwise>COALESCE(i.END_TIME, i.DELETED_AT)</otherwise>
        </choose>
        <choose>
            <when test="request.sortDirection != null and request.sortDirection.equalsIgnoreCase('asc')">ASC</when>
            <otherwise>DESC</otherwise>
        </choose>
        LIMIT #{request.size} OFFSET #{request.offset}
    </select>

    <!-- 작업 처리 이력 총 개수 조회 -->
    <select id="countItemHistory" resultType="long">
        SELECT COUNT(*)
        FROM TB_ITEM i
        <include refid="historyConditions"/>
    </select>

</mapper>
