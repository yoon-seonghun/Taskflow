# DB 스키마 유효성 검증 보고서

## 검증 개요

| 항목 | 내용 |
|------|------|
| 검증 일시 | 2025-12-24 |
| 검증 대상 | docker/mysql/init/01_schema.sql, 02_init_data.sql |
| 검증 기준 | CLAUDE.md DB 스키마 일관성 원칙 |
| 검증 결과 | **통과** (경미한 예외 사항 존재) |

---

## CLAUDE.md DB 스키마 규칙

```
1. 테이블명: 대문자, 스네이크케이스 (예: TB_USER, TB_ITEM)
2. PK 명명: TB명_ID (예: USER_ID, ITEM_ID)
3. 날짜 타입: DATE/DATETIME (문자열 저장 금지)
4. 공통 컬럼 (모든 테이블 필수):
   - CREATED_AT DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
   - CREATED_BY BIGINT NOT NULL
   - UPDATED_AT DATETIME NULL ON UPDATE CURRENT_TIMESTAMP
   - UPDATED_BY BIGINT NULL
```

---

## 검증 결과 상세

### 1. 테이블 명명 규칙 - ✅ 통과

| 테이블명 | 규칙 준수 |
|----------|-----------|
| TB_DEPARTMENT | ✅ |
| TB_USER | ✅ |
| TB_GROUP | ✅ |
| TB_USER_GROUP | ✅ |
| TB_BOARD | ✅ |
| TB_BOARD_SHARE | ✅ |
| TB_PROPERTY_DEF | ✅ |
| TB_PROPERTY_OPTION | ✅ |
| TB_ITEM | ✅ |
| TB_ITEM_PROPERTY | ✅ |
| TB_ITEM_PROPERTY_MULTI | ✅ |
| TB_COMMENT | ✅ |
| TB_TASK_TEMPLATE | ✅ |
| TB_ITEM_SHARE | ✅ |
| TB_AUDIT_LOG | ✅ |
| TB_FILE | ✅ |

**결과**: 모든 테이블이 `TB_` 프리픽스, 대문자, 스네이크케이스 규칙 준수

---

### 2. PK 명명 규칙 - ✅ 통과

| 테이블명 | PK 컬럼명 | 규칙 준수 |
|----------|-----------|-----------|
| TB_DEPARTMENT | DEPARTMENT_ID | ✅ |
| TB_USER | USER_ID | ✅ |
| TB_GROUP | GROUP_ID | ✅ |
| TB_USER_GROUP | USER_GROUP_ID | ✅ |
| TB_BOARD | BOARD_ID | ✅ |
| TB_BOARD_SHARE | BOARD_SHARE_ID | ✅ |
| TB_PROPERTY_DEF | PROPERTY_ID | ✅ |
| TB_PROPERTY_OPTION | OPTION_ID | ✅ |
| TB_ITEM | ITEM_ID | ✅ |
| TB_ITEM_PROPERTY | ITEM_PROPERTY_ID | ✅ |
| TB_ITEM_PROPERTY_MULTI | ITEM_PROPERTY_MULTI_ID | ✅ |
| TB_COMMENT | COMMENT_ID | ✅ |
| TB_TASK_TEMPLATE | TEMPLATE_ID | ✅ |
| TB_ITEM_SHARE | ITEM_SHARE_ID | ✅ |
| TB_AUDIT_LOG | LOG_ID | ✅ |
| TB_FILE | FILE_ID | ✅ |

**결과**: 모든 PK가 `테이블명_ID` 형식 준수

---

### 3. 날짜 타입 - ✅ 통과

| 필드 | 타입 | 테이블 예시 |
|------|------|-------------|
| CREATED_AT | DATETIME | 모든 테이블 |
| UPDATED_AT | DATETIME | 대부분 테이블 |
| START_TIME | DATETIME | TB_ITEM |
| END_TIME | DATETIME | TB_ITEM |
| DELETED_AT | DATETIME | TB_ITEM |
| TRANSFERRED_AT | DATETIME | TB_ITEM |
| LAST_LOGIN_AT | DATETIME | TB_USER |
| VALUE_DATE | DATE | TB_ITEM_PROPERTY |

**결과**: 모든 날짜/시간 필드가 DATE 또는 DATETIME 타입 사용

---

### 4. 공통 컬럼 - ⚠️ 경미한 예외 존재

| 테이블 | CREATED_AT | CREATED_BY | UPDATED_AT | UPDATED_BY | 비고 |
|--------|:----------:|:----------:|:----------:|:----------:|------|
| TB_DEPARTMENT | ✅ | ✅ | ✅ | ✅ | |
| TB_USER | ✅ | ✅ | ✅ | ✅ | |
| TB_GROUP | ✅ | ✅ | ✅ | ✅ | |
| TB_USER_GROUP | ✅ | ✅ | ❌ | ❌ | 매핑 테이블 |
| TB_BOARD | ✅ | ✅ | ✅ | ✅ | |
| TB_BOARD_SHARE | ✅ | ✅ | ❌ | ❌ | 매핑 테이블 |
| TB_PROPERTY_DEF | ✅ | ✅ | ✅ | ✅ | |
| TB_PROPERTY_OPTION | ✅ | ✅ | ✅ | ✅ | |
| TB_ITEM | ✅ | ✅ | ✅ | ✅ | |
| TB_ITEM_PROPERTY | ✅ | ✅ | ✅ | ✅ | |
| TB_ITEM_PROPERTY_MULTI | ✅ | ✅ | ❌ | ❌ | 매핑 테이블 |
| TB_COMMENT | ✅ | ✅ | ✅ | ✅ | |
| TB_TASK_TEMPLATE | ✅ | ✅ | ✅ | ✅ | |
| TB_ITEM_SHARE | ✅ | ✅ | ✅ | ✅ | |
| TB_AUDIT_LOG | ✅ | - | ❌ | ❌ | ACTOR_ID가 생성자 역할 |
| TB_FILE | ✅ | ✅ | ✅ | ✅ | |

**예외 사항 분석**:

1. **TB_USER_GROUP, TB_BOARD_SHARE, TB_ITEM_PROPERTY_MULTI**
   - 성격: N:M 관계 매핑 테이블
   - 사유: 매핑 데이터는 생성/삭제만 발생하며 수정이 없음
   - 영향도: **낮음** - 실무 운영에 영향 없음
   - 조치: 필요시 컬럼 추가 가능 (선택사항)

2. **TB_AUDIT_LOG**
   - 성격: 감사 로그 (불변 데이터)
   - 사유: 로그는 수정 불가, ACTOR_ID가 생성자 역할 수행
   - 영향도: **없음** - 의도된 설계
   - 조치: 현행 유지 권장

---

### 5. TB_AUDIT_LOG 테이블 - ✅ 존재 확인

```sql
CREATE TABLE TB_AUDIT_LOG (
    LOG_ID BIGINT NOT NULL AUTO_INCREMENT,
    TARGET_TYPE VARCHAR(20) NOT NULL,    -- BOARD/ITEM/BOARD_SHARE/ITEM_SHARE
    TARGET_ID BIGINT NOT NULL,
    ACTION VARCHAR(20) NOT NULL,         -- CREATE/UPDATE/DELETE/TRANSFER/SHARE/UNSHARE
    ACTOR_ID BIGINT NOT NULL,
    DESCRIPTION VARCHAR(500) NULL,
    BEFORE_DATA JSON NULL,
    AFTER_DATA JSON NULL,
    RELATED_USER_ID BIGINT NULL,
    CREATED_AT DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (LOG_ID)
);
```

**결과**: 감사 로그 테이블 정상 구현됨

---

## 백엔드 도메인/DTO 일관성 검증

### 검증 대상 파일

| 도메인 파일 | DB 테이블 | 일치 여부 |
|------------|-----------|-----------|
| User.java | TB_USER | ✅ |
| Board.java | TB_BOARD | ✅ |
| Item.java | TB_ITEM | ✅ |
| FileEntity.java | TB_FILE | ✅ |
| BoardShare.java | TB_BOARD_SHARE | ✅ |
| ItemShare.java | TB_ITEM_SHARE | ✅ |
| AuditLog.java | TB_AUDIT_LOG | ✅ |

### 주요 일치 사항

| 필드 | DB 스키마 | 백엔드 도메인 | 일치 |
|------|-----------|--------------|------|
| TB_USER.EMAIL | VARCHAR(100) NULL | String email | ✅ |
| TB_BOARD.COLOR | VARCHAR(7) NULL | String color | ✅ |
| TB_ITEM.TRANSFERRED_FROM | BIGINT NULL | Long transferredFrom | ✅ |
| TB_ITEM.TRANSFERRED_AT | DATETIME NULL | LocalDateTime transferredAt | ✅ |
| TB_FILE (전체) | 16개 컬럼 | FileEntity 클래스 | ✅ |

---

## 권한 체계 불일치 사항 - ⚠️ 주의

### 현황

| 구분 | TB_BOARD_SHARE | BoardShare.java |
|------|----------------|-----------------|
| 기본값 | MEMBER | - |
| 권한 종류 | MEMBER/VIEWER | VIEW/EDIT/FULL |

### 분석

- 스키마에는 레거시 권한 체계(MEMBER/VIEWER)가 기본값으로 설정됨
- 백엔드 코드는 새로운 권한 체계(VIEW/EDIT/FULL) 사용
- 스키마 파일 하단에 마이그레이션 가이드 주석 존재

### 마이그레이션 가이드 (스키마 내 주석)

```sql
-- 추후 마이그레이션 필요 시 아래 스크립트 사용:
-- ALTER TABLE TB_BOARD_SHARE
--     MODIFY COLUMN PERMISSION VARCHAR(20) NOT NULL DEFAULT 'VIEW';
-- UPDATE TB_BOARD_SHARE SET PERMISSION = 'VIEW' WHERE PERMISSION = 'VIEWER';
-- UPDATE TB_BOARD_SHARE SET PERMISSION = 'EDIT' WHERE PERMISSION = 'MEMBER';
```

### 권장 조치

- **현재 운영 DB**가 새 권한 체계(VIEW/EDIT/FULL)를 사용 중이면 init 스크립트 수정
- 신규 배포 환경에서 혼선 방지를 위해 스키마 기본값 업데이트 권장

---

## 초기 데이터(02_init_data.sql) 검증

### 검증 항목

| 항목 | 결과 |
|------|------|
| 필수 컬럼 포함 | ✅ |
| CREATED_BY 값 제공 | ✅ |
| FK 참조 무결성 | ✅ |
| AUTO_INCREMENT 재설정 | ✅ (100부터 시작) |
| 관리자 계정 암호화 | ✅ (BCrypt) |

### 초기 데이터 요약

| 테이블 | 초기 데이터 수 |
|--------|---------------|
| TB_DEPARTMENT | 8건 (부서 트리) |
| TB_USER | 1건 (admin) |
| TB_GROUP | 5건 |
| TB_USER_GROUP | 3건 |
| TB_BOARD | 1건 |
| TB_PROPERTY_DEF | 6건 |
| TB_PROPERTY_OPTION | 13건 |
| TB_TASK_TEMPLATE | 8건 |
| TB_ITEM | 5건 (샘플) |

---

## 최종 검증 결과

### 종합 평가

| 검증 항목 | 결과 | 비고 |
|----------|------|------|
| 테이블 명명 규칙 | ✅ 통과 | |
| PK 명명 규칙 | ✅ 통과 | |
| 날짜 타입 | ✅ 통과 | |
| 공통 컬럼 | ⚠️ 경미 예외 | 매핑 테이블 4개 |
| TB_AUDIT_LOG | ✅ 존재 | |
| 백엔드 일관성 | ✅ 통과 | |
| 초기 데이터 | ✅ 통과 | |

### 권장 조치 사항

1. **선택 사항**: 매핑 테이블(TB_USER_GROUP, TB_BOARD_SHARE, TB_ITEM_PROPERTY_MULTI)에 UPDATED_AT, UPDATED_BY 컬럼 추가
   - 규칙 완전 준수를 위한 선택적 개선
   - 운영 영향 없음

2. **권장 사항**: TB_BOARD_SHARE.PERMISSION 기본값을 'VIEW'로 변경
   - 백엔드 코드와 일관성 유지
   - 신규 환경 배포 시 혼선 방지

---

## 결론

**docker/mysql/init 스크립트는 CLAUDE.md DB 스키마 일관성 원칙을 대부분 준수하고 있으며, 현재 상태로 운영 가능합니다.**

경미한 예외 사항은 의도된 설계이거나 실무 영향이 없는 수준이며, 필요시 선택적으로 개선할 수 있습니다.
