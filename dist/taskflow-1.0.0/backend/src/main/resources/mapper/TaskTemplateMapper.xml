<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.taskflow.mapper.TaskTemplateMapper">

    <!-- ============================================= -->
    <!-- Result Map -->
    <!-- ============================================= -->

    <resultMap id="TaskTemplateResultMap" type="com.taskflow.domain.TaskTemplate">
        <id property="templateId" column="TEMPLATE_ID"/>
        <result property="content" column="CONTENT"/>
        <result property="defaultAssigneeId" column="DEFAULT_ASSIGNEE_ID"/>
        <result property="defaultItemStatus" column="DEFAULT_ITEM_STATUS"/>
        <result property="status" column="STATUS"/>
        <result property="sortOrder" column="SORT_ORDER"/>
        <result property="useCount" column="USE_COUNT"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="updatedBy" column="UPDATED_BY"/>
        <!-- 조인 필드 -->
        <result property="createdByName" column="CREATED_BY_NAME"/>
        <result property="updatedByName" column="UPDATED_BY_NAME"/>
        <result property="defaultAssigneeName" column="DEFAULT_ASSIGNEE_NAME"/>
    </resultMap>

    <!-- ============================================= -->
    <!-- 공통 SQL 조각 -->
    <!-- ============================================= -->

    <sql id="selectTaskTemplate">
        SELECT
            t.TEMPLATE_ID,
            t.CONTENT,
            t.DEFAULT_ASSIGNEE_ID,
            t.DEFAULT_ITEM_STATUS,
            CASE WHEN t.USE_YN = 'Y' THEN 'ACTIVE' ELSE 'INACTIVE' END AS STATUS,
            t.SORT_ORDER,
            t.USE_COUNT,
            t.CREATED_AT,
            t.CREATED_BY,
            t.UPDATED_AT,
            t.UPDATED_BY,
            uc.NAME AS CREATED_BY_NAME,
            uu.NAME AS UPDATED_BY_NAME,
            ua.NAME AS DEFAULT_ASSIGNEE_NAME
        FROM TB_TASK_TEMPLATE t
        LEFT JOIN TB_USER uc ON t.CREATED_BY = uc.USER_ID
        LEFT JOIN TB_USER uu ON t.UPDATED_BY = uu.USER_ID
        LEFT JOIN TB_USER ua ON t.DEFAULT_ASSIGNEE_ID = ua.USER_ID
    </sql>

    <!-- ============================================= -->
    <!-- 조회 -->
    <!-- ============================================= -->

    <!-- 템플릿 ID로 조회 -->
    <select id="findById" resultMap="TaskTemplateResultMap">
        <include refid="selectTaskTemplate"/>
        WHERE t.TEMPLATE_ID = #{templateId}
    </select>

    <!-- 전체 템플릿 목록 조회 -->
    <select id="findAll" resultMap="TaskTemplateResultMap">
        <include refid="selectTaskTemplate"/>
        ORDER BY t.CREATED_AT DESC
    </select>

    <!-- 활성 템플릿 목록 조회 -->
    <select id="findAllActive" resultMap="TaskTemplateResultMap">
        <include refid="selectTaskTemplate"/>
        WHERE t.USE_YN = 'Y'
        ORDER BY t.CREATED_AT DESC
    </select>

    <!-- 키워드로 템플릿 검색 (자동완성용) -->
    <select id="searchByKeyword" resultMap="TaskTemplateResultMap">
        <include refid="selectTaskTemplate"/>
        WHERE t.USE_YN = 'Y'
          AND t.CONTENT LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY
            CASE WHEN t.CONTENT LIKE CONCAT(#{keyword}, '%') THEN 0 ELSE 1 END,
            t.CONTENT
        LIMIT #{limit}
    </select>

    <!-- 작업 내용으로 조회 (중복 체크) -->
    <select id="findByContent" resultMap="TaskTemplateResultMap">
        <include refid="selectTaskTemplate"/>
        WHERE t.CONTENT = #{content}
    </select>

    <!-- 최대 정렬 순서 조회 -->
    <select id="getMaxSortOrder" resultType="int">
        SELECT COALESCE(MAX(SORT_ORDER), 0) FROM TB_TASK_TEMPLATE
    </select>

    <!-- ============================================= -->
    <!-- 등록/수정/삭제 -->
    <!-- ============================================= -->

    <!-- 템플릿 등록 -->
    <insert id="insert" parameterType="com.taskflow.domain.TaskTemplate" useGeneratedKeys="true" keyProperty="templateId">
        INSERT INTO TB_TASK_TEMPLATE (
            CONTENT,
            DEFAULT_ASSIGNEE_ID,
            DEFAULT_ITEM_STATUS,
            SORT_ORDER,
            USE_COUNT,
            USE_YN,
            CREATED_BY
        ) VALUES (
            #{content},
            #{defaultAssigneeId},
            #{defaultItemStatus},
            COALESCE(#{sortOrder}, 0),
            COALESCE(#{useCount}, 0),
            CASE WHEN #{status} = 'ACTIVE' THEN 'Y' WHEN #{status} = 'INACTIVE' THEN 'N' ELSE 'Y' END,
            #{createdBy}
        )
    </insert>

    <!-- 템플릿 수정 -->
    <update id="update" parameterType="com.taskflow.domain.TaskTemplate">
        UPDATE TB_TASK_TEMPLATE
        SET
            CONTENT = #{content},
            DEFAULT_ASSIGNEE_ID = #{defaultAssigneeId},
            DEFAULT_ITEM_STATUS = #{defaultItemStatus},
            SORT_ORDER = COALESCE(#{sortOrder}, SORT_ORDER),
            USE_YN = CASE WHEN #{status} = 'ACTIVE' THEN 'Y' WHEN #{status} = 'INACTIVE' THEN 'N' ELSE USE_YN END,
            UPDATED_BY = #{updatedBy},
            UPDATED_AT = CURRENT_TIMESTAMP
        WHERE TEMPLATE_ID = #{templateId}
    </update>

    <!-- 템플릿 삭제 -->
    <delete id="delete">
        DELETE FROM TB_TASK_TEMPLATE
        WHERE TEMPLATE_ID = #{templateId}
    </delete>

    <!-- 사용 횟수 증가 -->
    <update id="incrementUseCount">
        UPDATE TB_TASK_TEMPLATE
        SET USE_COUNT = USE_COUNT + 1
        WHERE TEMPLATE_ID = #{templateId}
    </update>

    <!-- ============================================= -->
    <!-- 이력 조회 -->
    <!-- ============================================= -->

    <!-- 템플릿 이력 필터 조건 -->
    <sql id="templateHistoryConditions">
        <where>
            <if test="request.status != null and request.status != ''">
                AND t.USE_YN = CASE
                    WHEN #{request.status} = 'ACTIVE' THEN 'Y'
                    WHEN #{request.status} = 'INACTIVE' THEN 'N'
                    ELSE #{request.status}
                END
            </if>
            <if test="request.createdBy != null">
                AND t.CREATED_BY = #{request.createdBy}
            </if>
            <if test="request.startDate != null">
                AND DATE(t.CREATED_AT) >= #{request.startDate}
            </if>
            <if test="request.endDate != null">
                AND DATE(t.CREATED_AT) &lt;= #{request.endDate}
            </if>
            <if test="request.keyword != null and request.keyword != ''">
                AND t.CONTENT LIKE CONCAT('%', #{request.keyword}, '%')
            </if>
        </where>
    </sql>

    <!-- 템플릿 이력 조회 -->
    <select id="findTemplateHistory" resultMap="TaskTemplateResultMap">
        <include refid="selectTaskTemplate"/>
        <include refid="templateHistoryConditions"/>
        ORDER BY
        <choose>
            <when test="request.sortField == 'content'">t.CONTENT</when>
            <when test="request.sortField == 'status'">t.USE_YN</when>
            <when test="request.sortField == 'createdByName'">CREATED_BY_NAME</when>
            <when test="request.sortField == 'updatedAt'">t.UPDATED_AT</when>
            <otherwise>t.CREATED_AT</otherwise>
        </choose>
        <choose>
            <when test="request.sortDirection != null and request.sortDirection.equalsIgnoreCase('asc')">ASC</when>
            <otherwise>DESC</otherwise>
        </choose>
        LIMIT #{request.size} OFFSET #{request.offset}
    </select>

    <!-- 템플릿 이력 총 개수 조회 -->
    <select id="countTemplateHistory" resultType="long">
        SELECT COUNT(*)
        FROM TB_TASK_TEMPLATE t
        <include refid="templateHistoryConditions"/>
    </select>

</mapper>
