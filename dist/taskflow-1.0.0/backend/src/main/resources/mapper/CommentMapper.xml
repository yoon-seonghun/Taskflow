<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.taskflow.mapper.CommentMapper">

    <!-- ============================================= -->
    <!-- Result Map -->
    <!-- ============================================= -->

    <resultMap id="CommentResultMap" type="com.taskflow.domain.Comment">
        <id property="commentId" column="COMMENT_ID"/>
        <result property="itemId" column="ITEM_ID"/>
        <result property="content" column="CONTENT"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="updatedBy" column="UPDATED_BY"/>
        <!-- 조인 필드 -->
        <result property="itemTitle" column="ITEM_TITLE"/>
        <result property="createdByName" column="CREATED_BY_NAME"/>
        <result property="updatedByName" column="UPDATED_BY_NAME"/>
    </resultMap>

    <!-- ============================================= -->
    <!-- 공통 SQL 조각 -->
    <!-- ============================================= -->

    <sql id="selectComment">
        SELECT
            c.COMMENT_ID,
            c.ITEM_ID,
            c.CONTENT,
            c.CREATED_AT,
            c.CREATED_BY,
            c.UPDATED_AT,
            c.UPDATED_BY,
            i.CONTENT AS ITEM_TITLE,
            uc.NAME AS CREATED_BY_NAME,
            uu.NAME AS UPDATED_BY_NAME
        FROM TB_COMMENT c
        INNER JOIN TB_ITEM i ON c.ITEM_ID = i.ITEM_ID
        LEFT JOIN TB_USER uc ON c.CREATED_BY = uc.USER_ID
        LEFT JOIN TB_USER uu ON c.UPDATED_BY = uu.USER_ID
    </sql>

    <!-- ============================================= -->
    <!-- 조회 -->
    <!-- ============================================= -->

    <!-- 댓글 ID로 조회 -->
    <select id="findById" resultMap="CommentResultMap">
        <include refid="selectComment"/>
        WHERE c.COMMENT_ID = #{commentId}
    </select>

    <!-- 아이템별 댓글 목록 조회 -->
    <select id="findByItemId" resultMap="CommentResultMap">
        <include refid="selectComment"/>
        WHERE c.ITEM_ID = #{itemId}
        ORDER BY c.CREATED_AT ASC
    </select>

    <!-- 아이템별 댓글 수 조회 -->
    <select id="countByItemId" resultType="int">
        SELECT COUNT(*)
        FROM TB_COMMENT
        WHERE ITEM_ID = #{itemId}
    </select>

    <!-- ============================================= -->
    <!-- 등록/수정/삭제 -->
    <!-- ============================================= -->

    <!-- 댓글 등록 -->
    <insert id="insert" parameterType="com.taskflow.domain.Comment" useGeneratedKeys="true" keyProperty="commentId">
        INSERT INTO TB_COMMENT (
            ITEM_ID,
            CONTENT,
            CREATED_BY
        ) VALUES (
            #{itemId},
            #{content},
            #{createdBy}
        )
    </insert>

    <!-- 댓글 수정 -->
    <update id="update" parameterType="com.taskflow.domain.Comment">
        UPDATE TB_COMMENT
        SET
            CONTENT = #{content},
            UPDATED_BY = #{updatedBy},
            UPDATED_AT = CURRENT_TIMESTAMP
        WHERE COMMENT_ID = #{commentId}
    </update>

    <!-- 댓글 삭제 -->
    <delete id="delete">
        DELETE FROM TB_COMMENT
        WHERE COMMENT_ID = #{commentId}
    </delete>

    <!-- 아이템의 모든 댓글 삭제 -->
    <delete id="deleteByItemId">
        DELETE FROM TB_COMMENT
        WHERE ITEM_ID = #{itemId}
    </delete>

</mapper>
